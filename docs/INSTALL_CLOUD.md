# Cloud Backend Installation Guide

**Last Updated**: 2025-01-30  
**Version**: 1.0

---

## Overview

This guide covers the installation and setup of the Cloud Backend (Laravel) for the STC AI-VAP Platform.

---

## Requirements

### Operating System
- **Linux**: Ubuntu 20.04+ / Debian 11+ / CentOS 8+
- **Windows**: Windows 10/11 (for development only)
- **macOS**: macOS 10.15+ (for development only)

### Software Requirements
- **PHP**: 8.2 or higher
- **Composer**: 2.6+ (PHP package manager)
- **MySQL**: 8.0+ or MariaDB 10.6+
- **Node.js**: 18.x or higher (for asset compilation)
- **npm**: 9.x or higher

### PHP Extensions
Required PHP extensions:
- `pdo_mysql`
- `mbstring`
- `xml`
- `curl`
- `zip`
- `gd` or `imagick`
- `bcmath`
- `fileinfo`
- `openssl`

---

## Installation Steps

### 1. Clone Repository

```bash
git clone <repository-url>
cd ptz/apps/cloud-laravel
```

### 2. Install PHP Dependencies

```bash
composer install --no-dev --optimize-autoloader
```

For development:
```bash
composer install
```

### 3. Environment Configuration

```bash
cp .env.example .env
php artisan key:generate
```

Edit `.env` file with your configuration:

```env
APP_NAME="STC AI-VAP"
APP_ENV=production
APP_KEY=base64:... (generated by key:generate)
APP_DEBUG=false
APP_URL=https://your-domain.com

DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=stc_ai_vap
DB_USERNAME=your_db_user
DB_PASSWORD=your_db_password

# Super Admin Credentials (for initial setup)
SUPER_ADMIN_EMAIL=admin@example.com
SUPER_ADMIN_PASSWORD=secure_password_here

# License Grace Period (days)
LICENSE_GRACE_PERIOD_DAYS=14
```

### 4. Database Setup

#### Create Database

```bash
mysql -u root -p
```

```sql
CREATE DATABASE stc_ai_vap CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'stc_user'@'localhost' IDENTIFIED BY 'strong_password_here';
GRANT ALL PRIVILEGES ON stc_ai_vap.* TO 'stc_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

#### Run Migrations

```bash
php artisan migrate:fresh --seed
```

This will:
- Create all database tables
- Add foreign keys and indexes
- Seed initial data (subscription plans, super admin user)

### 5. Storage & Permissions

```bash
php artisan storage:link
chmod -R 775 storage bootstrap/cache
chown -R www-data:www-data storage bootstrap/cache
```

### 6. Optimize for Production

```bash
php artisan config:cache
php artisan route:cache
php artisan view:cache
```

---

## Running the Application

### Development Mode

```bash
php artisan serve
```

Access at: `http://localhost:8000`

### Production Mode (Nginx + PHP-FPM)

See `docs/RUNBOOK.md` for production deployment with Nginx.

---

## Common Commands

### Database

```bash
# Run migrations
php artisan migrate

# Rollback last migration
php artisan migrate:rollback

# Fresh migration with seed
php artisan migrate:fresh --seed

# Check migration status
php artisan migrate:status
```

### Testing

```bash
# Run all tests
php artisan test

# Run specific test
php artisan test --filter TenantIsolationTest

# Run with coverage
php artisan test --coverage
```

### Maintenance

```bash
# Clear all caches
php artisan cache:clear
php artisan config:clear
php artisan route:clear
php artisan view:clear

# Optimize
php artisan optimize

# License deactivation (scheduled task)
php artisan licenses:deactivate-expired
```

---

## Environment Variables

### Required Variables

| Variable | Description | Example |
|----------|-------------|---------|
| `APP_ENV` | Environment | `production` |
| `APP_KEY` | Application key | `base64:...` |
| `DB_DATABASE` | Database name | `stc_ai_vap` |
| `DB_USERNAME` | Database user | `stc_user` |
| `DB_PASSWORD` | Database password | `secure_password` |
| `SUPER_ADMIN_EMAIL` | Super admin email | `admin@example.com` |
| `SUPER_ADMIN_PASSWORD` | Super admin password | `secure_password` |

### Optional Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `LICENSE_GRACE_PERIOD_DAYS` | License grace period | `14` |
| `APP_DEBUG` | Debug mode | `false` |
| `LOG_LEVEL` | Logging level | `error` |

---

## Common Errors & Fixes

### Error: "SQLSTATE[HY000] [2002] Connection refused"

**Cause**: Database connection failed

**Fix**:
```bash
# Check MySQL is running
sudo systemctl status mysql

# Verify credentials in .env
# Test connection
mysql -u your_user -p -h 127.0.0.1
```

### Error: "The stream or file could not be opened"

**Cause**: Storage permissions issue

**Fix**:
```bash
chmod -R 775 storage bootstrap/cache
chown -R www-data:www-data storage bootstrap/cache
```

### Error: "Class 'X' not found"

**Cause**: Autoloader not updated

**Fix**:
```bash
composer dump-autoload
php artisan optimize:clear
```

### Error: "419 Page Expired" or CSRF token mismatch

**Cause**: Session/cache issues

**Fix**:
```bash
php artisan cache:clear
php artisan config:clear
php artisan session:clear
```

---

## Verification

### 1. Check API Health

```bash
curl http://localhost:8000/api/up
```

Should return: `{"status":"ok"}`

### 2. Test Login

```bash
curl -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@example.com","password":"your_password"}'
```

Should return: `{"token":"...","user":{...}}`

### 3. Run Tests

```bash
php artisan test
```

All tests should pass.

---

## Next Steps

1. **Configure Web Portal**: See `docs/INSTALL_WEB.md`
2. **Setup Edge Server**: See `docs/INSTALL_EDGE.md`
3. **Production Deployment**: See `docs/RUNBOOK.md`

---

## Support

For issues or questions:
- Check `docs/RUNBOOK.md` for troubleshooting
- Review `docs/FINAL_CODE_REVIEW.md` for known issues
- Contact: support@stcsolutions.net

---

**Last Updated**: 2025-01-30
